<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>C Tutor — Tutor View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0 }
    header { background:#0f172a; color:#fff; padding:12px 16px; }
    main { padding:12px }
    .sub { border:1px solid #ddd; padding:8px; margin-bottom:8px; }
    .meta { font-size:13px; color:#555 }
    pre { background:#f7f7f7; padding:8px; white-space:pre-wrap; overflow:auto }
    input[type=text] { width:360px; padding:6px }
  </style>
</head>
<body>
  <header><strong>C Tutor — Tutor</strong></header>
  <main>
    <div style="margin-bottom:12px;">
      <strong>Current Question:</strong> <span id="questionNum">...</span>
      <button id="progressBtn">Progress Question</button>
      <button id="nextFileBtn">Next Tutor File</button>
      <button id="endClassBtn">End Class</button>
    </div>

    <div style="margin-bottom:12px;">
      <input id="filter" type="text" placeholder="Filter by student name or id" />
      <button id="refresh">Refresh</button>
      <button id="toggleNamesBtn">Hide Student Names</button>
    </div>
    <div id="list"></div>
  </main>

  <script>
    let namesHidden = false;
    document.getElementById('toggleNamesBtn').addEventListener('click', () => {
      namesHidden = !namesHidden;
      document.getElementById('toggleNamesBtn').innerText = namesHidden ? 'Show Student Names' : 'Hide Student Names';

      document.querySelectorAll('.studentName').forEach(span => {
        span.style.display = namesHidden ? 'none' : 'inline';
      });
    });

    let classEnded = false;

    document.getElementById('endClassBtn').addEventListener('click', () => {
      classEnded = true;
      load(); // reload submissions, now showing all questions
    });

    async function refreshQuestion() {
      const res = await fetch('/api/current-question');
      const j = await res.json();
      document.getElementById('questionNum').innerText = j.question;
    }

    document.getElementById('progressBtn').addEventListener('click', async () => {
      const res = await fetch('/api/progress-question', { method: 'POST' });
      const j = await res.json();
      if (j.ok) {
        document.getElementById('questionNum').innerText = j.question;
        load(); // reload submissions for new question
      }
    });

    document.getElementById('nextFileBtn').addEventListener('click', async () => {
      const res = await fetch('/api/next-file', { method: 'POST' });
      const j = await res.json();
      if (j.ok) {
        alert('Now using file ' + j.index);
      }
    });


    async function load() {
      const res = await fetch('/api/submissions');
      const j = await res.json();
      const list = document.getElementById('list');
      list.innerHTML = '';

      if (!j.ok) {
        list.innerText = 'Failed to load';
        return;
      }

      let submissionsToShow;

      if (classEnded) {
        submissionsToShow = j.submissions; // show all
      } else {
        const currentQuestion = parseInt(document.getElementById('questionNum').innerText);
        submissionsToShow = j.submissions.filter(sub => sub.question === currentQuestion);
      }
      const filter = document.getElementById('filter').value.trim().toLowerCase();
      submissionsToShow.forEach(sub => {
        if (filter) {
          const hay = (sub.studentName + ' ' + sub.id).toLowerCase();
          if (!hay.includes(filter)) return;
        }
        const div = document.createElement('div');
        div.className = 'sub';
        div.innerHTML = `
          <div class="meta">
            Q${sub.question} — <span class="studentName">${sub.studentName}</span> — ${new Date(sub.timestamp).toLocaleString()}
          </div>
          <pre>${escapeHtml(sub.code)}</pre>
        `;

        // Apply current hide names setting
        if (namesHidden) {
          div.querySelector('.studentName').style.display = 'none';
        }

        list.appendChild(div);
      });
  }

    refreshQuestion();
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    document.getElementById('refresh').addEventListener('click', load);
    document.getElementById('filter').addEventListener('input', load);
    load();
  </script>
</body>
</html>