<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>C Tutor — Student</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding: 0; }
    header { background:#0f172a; color: #fff; padding: 12px 16px; display:flex; align-items:center; justify-content:space-between }
    main { padding: 12px; }
    #editor { width:100%; height:60vh; border:1px solid #ddd }
    .row { display:flex; gap:8px; align-items:center }
    input[type=text] { width: 420px; padding:6px }
    button { padding:8px 12px; cursor:pointer }
    label { font-size:14px }
  </style>
  <!-- Ace Editor CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
</head>
<body>
  <header>
    <div><strong>C Tutor — Student</strong></div>
    <div><a href="/tutor.html" style="color:#9bd">Open tutor view</a></div>
  </header>
  <main>
    <div style="margin-bottom:8px" class="row">
      <label for="studentName">Name:</label>
      <input id="studentName" type="text" placeholder="Your name (optional)" />
      <button id="fetchBtn">Fetch Tutor Code</button>
      <button id="submitBtn">Submit</button>
    </div>

    <div id="editor">/* C code goes here */</div>

    <div id="status" style="margin-top:8px"></div>
  </main>

  <script>
    // Initialize Ace editor
    const editor = ace.edit('editor');
    editor.setTheme('ace/theme/textmate');
    editor.getSession().setMode('ace/mode/c_cpp');
    editor.getSession().setTabSize(4);
    editor.getSession().setUseSoftTabs(true);
    editor.setOptions({enableBasicAutocompletion: true, enableLiveAutocompletion: true});


    document.getElementById('fetchBtn').addEventListener('click', async () => {
      try {
        const resUrl = await fetch('/api/current-file');
        const { url } = await resUrl.json();
        if (!url) throw new Error('Tutor code URL not configured.');

        const res = await fetch('/api/fetch-tutor?url=' + encodeURIComponent(url));
        if (!res.ok) throw new Error('Failed to fetch code: ' + res.status);
        const text = await res.text();
        editor.setValue(text, -1);
        document.getElementById('status').innerText = 'Fetched current tutor code.';
      } catch (err) {
        console.error(err);
        alert('Failed to fetch tutor code: ' + err.message);
      }
    });


    document.getElementById('submitBtn').addEventListener('click', async () => {
      const code = editor.getValue();
      const studentName = document.getElementById('studentName').value.trim() || 'anonymous';
      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentName, code, metadata: { userAgent: navigator.userAgent } })
        });
        const j = await res.json();
        if (j.ok) {
          document.getElementById('status').innerText = 'Submission saved. ID: ' + j.submission.id;
        } else {
          document.getElementById('status').innerText = 'Submission failed';
        }
      } catch (err) {
        console.error(err);
        alert('Submit failed: ' + err.message);
      }
    });
  </script>
</body>
</html>